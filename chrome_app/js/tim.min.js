(function(name,definition,context){if(typeof module!="undefined"&&module.exports){module.exports=definition()}else if(typeof context["define"]=="function"&&context["define"]["amd"]){define(definition)}else{context[name]=definition()}})("tim",function(){var tim=function createTim(initSettings){"use strict";var settings={start:"{{",end:"}}",path:"[a-z0-9_$][\\.a-z0-9_]*"},templates={},filters={},stopThisFilter,pattern,initialized,undef;function patternCache(){pattern=new RegExp(settings.start+"\\s*("+settings.path+")\\s*"+settings.end,"gi")}function settingsCache(newSettings){var s;if(newSettings){for(s in newSettings){if(newSettings.hasOwnProperty(s)){settings[s]=newSettings[s]}}patternCache()}return settings}if(initSettings){settingsCache(initSettings)}else{patternCache()}function templatesCache(key,value){var t;switch(typeof key){case"string":if(value===undef){return templates[key]||""}else if(value===false){delete templates[key]}else{templates[key]=value}break;case"object":for(t in key){if(key.hasOwnProperty(t)){templatesCache(t,key[t])}}break;case"boolean":if(!key){templates={}}break}return templates}function extend(obj1,obj2){var key;for(key in obj2){if(obj2.hasOwnProperty(key)){obj1[key]=obj2[key]}}return obj1}function sortByPriority(a,b){return a[1]-b[1]}function addFilter(filterName,fn,priority){var fns=filters[filterName];if(!fns){fns=filters[filterName]=[]}fns.push([fn,priority||0]);fns.sort(sortByPriority);return fn}function applyFilter(filterName,payload){var fns=filters[filterName],args,i,len,substituted;if(fns){args=[payload];i=2;len=arguments.length;for(;i<len;i++){args.push(arguments[i])}i=0;len=fns.length;for(;i<len;i++){args[0]=payload;substituted=fns[i][0].apply(null,args);if(payload!==undef&&substituted!==undef){payload=substituted}if(substituted===null){payload=""}if(stopThisFilter){stopThisFilter=false;break}}}return payload}function filter(filterName,payload){return(typeof payload==="function"?addFilter:applyFilter).apply(null,arguments)}filter.stop=function(){stopThisFilter=true};function substitute(template,data){var match,tag,token,substituted,startPos,endPos,templateStart,templateEnd,subTemplate,closeToken,closePos,key,loopData,loop;while((match=pattern.exec(template))!==null){token=match[1];substituted=applyFilter("token",token,data,template);startPos=match.index;endPos=pattern.lastIndex;templateStart=template.slice(0,startPos);templateEnd=template.slice(endPos);if(typeof substituted==="function"){substituted=substituted.call(data)}if(typeof substituted!=="boolean"&&typeof substituted!=="object"){template=templateStart+substituted+templateEnd}else{subTemplate="";closeToken=settings.start+"/"+token+settings.end;closePos=templateEnd.indexOf(closeToken);if(closePos>=0){templateEnd=templateEnd.slice(0,closePos);if(typeof substituted==="boolean"){subTemplate=substituted?templateEnd:""}else{for(key in substituted){if(substituted.hasOwnProperty(key)){pattern.lastIndex=0;loopData=extend({_key:key,_content:substituted[key]},substituted[key]);loopData=applyFilter("loopData",loopData,loop,token);loop=tim(templateEnd,loopData);subTemplate+=applyFilter("loop",loop,token,loopData)}}subTemplate=applyFilter("loopEnd",subTemplate,token,loopData)}template=templateStart+subTemplate+template.slice(endPos+templateEnd.length+closeToken.length)}else{throw"tim: '"+token+"' not closed"}}pattern.lastIndex=0}return template}function tim(template,data){var templateLookup;if(!initialized){initialized=1;applyFilter("init")}template=applyFilter("templateBefore",template);if(template.indexOf(settings.start)<0){templateLookup=templatesCache(template);if(templateLookup){template=templateLookup}}template=applyFilter("template",template);if(template&&data!==undef){template=substitute(template,data)}template=applyFilter("templateAfter",template);return template}tim.settings=settingsCache;tim.templates=templatesCache;tim.parser=createTim;tim.filter=filter;addFilter("token",function(token,data,tag){var path=token.split("."),len=path.length,dataLookup=data,i=0;for(;i<len;i++){dataLookup=dataLookup[path[i]];if(dataLookup===undef){throw"tim: '"+path[i]+"' not found"+(i?" in "+tag:"")}if(i===len-1){return dataLookup}}});if(window&&window.document){tim.dom=function(domSettings){domSettings=domSettings||{};var type=domSettings.type||settings.type||"text/tim",attr=domSettings.attr||settings.attr||"class",document=window.document,hasQuery=!!document.querySelectorAll,elements=hasQuery?document.querySelectorAll("script[type='"+type+"']"):document.getElementsByTagName("script"),i=0,len=elements.length,elem,key,templatesInDom={};for(;i<len;i++){elem=elements[i];key=attr==="class"?elem.className:elem.getAttribute(attr);if(key&&(hasQuery||elem.type===type)){templatesInDom[key]=elem.innerHTML}}templatesCache(templatesInDom);return templatesInDom};addFilter("init",function(){tim.dom()})}return tim}();return tim},this);